<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 2000">
  <defs>
    <style>
      .start-end { fill: #90EE90; stroke: #000; stroke-width: 2; }
      .process { fill: #87CEEB; stroke: #000; stroke-width: 2; }
      .io { fill: #FFD700; stroke: #000; stroke-width: 2; }
      .parallel { fill: #DDA0DD; stroke: #000; stroke-width: 2; }
      .async { fill: #FF99CC; stroke: #000; stroke-width: 2; }
      .text { font-family: Arial; font-size: 12px; text-anchor: middle; }
      .title { font-family: Arial; font-size: 17px; font-weight: bold; text-anchor: middle; }
      .cluster-label { font-family: Arial; font-size: 14px; font-weight: bold; fill: #333; }
      .arrow { fill: none; stroke: #000; stroke-width: 2; marker-end: url(#arrowhead); }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#000" />
    </marker>
  </defs>
  
  <text x="600" y="30" class="title">Задание 3: Профилирование гибридного приложения</text>
  
  <ellipse cx="600" cy="80" rx="80" ry="30" class="start-end"/>
  <text x="600" y="85" class="text">Начало</text>
  
  <line x1="600" y1="110" x2="600" y2="140" class="arrow"/>
  
  <rect x="500" y="140" width="200" height="60" rx="5" class="process"/>
  <text x="600" y="160" class="text">Инициализация:</text>
  <text x="600" y="177" class="text">массив 10 млн элементов</text>
  <text x="600" y="193" class="text">pinned memory</text>
  
  <line x1="600" y1="200" x2="600" y2="230" class="arrow"/>
  
  <!-- Тест 1: CPU only -->
  <rect x="400" y="230" width="400" height="150" rx="5" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="600" y="250" class="cluster-label">ТЕСТ 1: Только CPU</text>
  
  <rect x="500" y="270" width="200" height="40" rx="5" class="process"/>
  <text x="600" y="295" class="text">Старт таймера CPU</text>
  
  <line x1="600" y1="310" x2="600" y2="330" class="arrow"/>
  
  <rect x="500" y="330" width="200" height="50" rx="5" class="process"/>
  <text x="600" y="350" class="text">processOnCPU</text>
  <text x="600" y="367" class="text">обработка всего массива</text>
  
  <line x1="600" y1="380" x2="600" y2="410" class="arrow"/>
  
  <!-- Тест 2: GPU only -->
  <rect x="350" y="410" width="500" height="330" rx="5" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="600" y="430" class="cluster-label">ТЕСТ 2: Только GPU (синхронная передача)</text>
  
  <rect x="500" y="450" width="200" height="40" rx="5" class="process"/>
  <text x="600" y="475" class="text">cudaMalloc, cudaEventCreate</text>
  
  <line x1="600" y1="490" x2="600" y2="510" class="arrow"/>
  
  <path d="M 520 510 L 680 510 L 660 560 L 500 560 Z" class="io"/>
  <text x="590" y="530" class="text">cudaMemcpy (синхронно)</text>
  <text x="590" y="547" class="text">Host → Device (блокирует CPU!)</text>
  
  <line x1="590" y1="560" x2="590" y2="590" class="arrow"/>
  
  <rect x="490" y="590" width="220" height="60" rx="5" class="process"/>
  <text x="600" y="610" class="text">Запуск ядра processOnGPU</text>
  <text x="600" y="627" class="text">cudaDeviceSynchronize</text>
  <text x="600" y="643" class="text">(ждём завершения)</text>
  
  <line x1="600" y1="650" x2="600" y2="680" class="arrow"/>
  
  <path d="M 520 680 L 680 680 L 660 730 L 500 730 Z" class="io"/>
  <text x="590" y="700" class="text">cudaMemcpy (синхронно)</text>
  <text x="590" y="717" class="text">Device → Host (блокирует!)</text>
  
  <line x1="590" y1="730" x2="590" y2="760" class="arrow"/>
  
  <!-- Тест 3: Гибрид базовый -->
  <rect x="250" y="760" width="700" height="350" rx="5" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="600" y="780" class="cluster-label">ТЕСТ 3: Гибридный базовый (CPU + GPU параллельно)</text>
  
  <rect x="500" y="800" width="200" height="60" rx="5" class="process"/>
  <text x="600" y="820" class="text">Деление массива:</text>
  <text x="600" y="837" class="text">30% → CPU</text>
  <text x="600" y="853" class="text">70% → GPU</text>
  
  <line x1="600" y1="860" x2="600" y2="890" class="arrow"/>
  <line x1="600" y1="890" x2="350" y2="890" class="arrow"/>
  <line x1="600" y1="890" x2="850" y2="890" class="arrow"/>
  
  <!-- CPU ветка -->
  <rect x="270" y="890" width="160" height="120" rx="5" class="parallel"/>
  <text x="350" y="915" class="text" font-weight="bold">CPU поток:</text>
  <text x="350" y="935" class="text">std::thread</text>
  <text x="350" y="952" class="text">processOnCPU</text>
  <text x="350" y="969" class="text">обработка</text>
  <text x="350" y="986" class="text">1-й половины</text>
  <text x="350" y="1002" class="text">массива</text>
  
  <!-- GPU ветка -->
  <rect x="770" y="890" width="160" height="160" rx="5" class="parallel"/>
  <text x="850" y="915" class="text" font-weight="bold">GPU ветка:</text>
  <text x="850" y="935" class="text">cudaMemcpy</text>
  <text x="850" y="952" class="text">2-й половины</text>
  <text x="850" y="969" class="text">↓</text>
  <text x="850" y="986" class="text">processOnGPU</text>
  <text x="850" y="1003" class="text">kernel</text>
  <text x="850" y="1020" class="text">↓</text>
  <text x="850" y="1037" class="text">cudaMemcpy back</text>
  
  <line x1="350" y1="1010" x2="350" y2="1090" class="arrow"/>
  <line x1="850" y1="1050" x2="850" y2="1090" class="arrow"/>
  <line x1="350" y1="1090" x2="600" y2="1090" class="arrow"/>
  <line x1="850" y1="1090" x2="600" y2="1090" class="arrow"/>
  
  <rect x="480" y="1090" width="240" height="50" rx="5" class="process"/>
  <text x="600" y="1110" class="text">Синхронизация:</text>
  <text x="600" y="1127" class="text">thread.join() + cudaSync()</text>
  
  <line x1="600" y1="1140" x2="600" y2="1170" class="arrow"/>
  
  <!-- Тест 4: Оптимизированный -->
  <rect x="200" y="1170" width="800" height="550" rx="5" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="600" y="1195" class="cluster-label">ТЕСТ 4: Оптимизированный (async + streams + chunks)</text>
  
  <rect x="450" y="1220" width="300" height="80" rx="5" class="process"/>
  <text x="600" y="1245" class="text" font-weight="bold">Подготовка:</text>
  <text x="600" y="1265" class="text">• cudaMallocHost (pinned memory)</text>
  <text x="600" y="1282" class="text">• cudaStreamCreate (stream1, stream2)</text>
  <text x="600" y="1298" class="text">• Деление GPU части на 2 чанка</text>
  
  <line x1="600" y1="1300" x2="600" y2="1330" class="arrow"/>
  
  <line x1="600" y1="1330" x2="300" y2="1330" class="arrow"/>
  <line x1="600" y1="1330" x2="600" y2="1360" class="arrow"/>
  <line x1="600" y1="1330" x2="900" y2="1330" class="arrow"/>
  
  <!-- CPU поток -->
  <rect x="230" y="1330" width="140" height="100" rx="5" class="parallel"/>
  <text x="300" y="1355" class="text" font-weight="bold">CPU поток:</text>
  <text x="300" y="1375" class="text">std::thread</text>
  <text x="300" y="1392" class="text">обработка</text>
  <text x="300" y="1409" class="text">CPU части</text>
  <text x="300" y="1425" class="text">(30%)</text>
  
  <!-- Stream 1 -->
  <rect x="490" y="1360" width="220" height="150" rx="5" class="async"/>
  <text x="600" y="1385" class="text" font-weight="bold">Stream 1 (асинхронно):</text>
  <text x="600" y="1405" class="text">cudaMemcpyAsync</text>
  <text x="600" y="1422" class="text">chunk1 → GPU</text>
  <text x="600" y="1439" class="text">↓</text>
  <text x="600" y="1456" class="text">processOnGPU</text>
  <text x="600" y="1473" class="text">↓</text>
  <text x="600" y="1490" class="text">cudaMemcpyAsync</text>
  <text x="600" y="1506" class="text">chunk1 ← GPU</text>
  
  <!-- Stream 2 -->
  <rect x="830" y="1360" width="220" height="150" rx="5" class="async"/>
  <text x="940" y="1385" class="text" font-weight="bold">Stream 2 (параллельно):</text>
  <text x="940" y="1405" class="text">cudaMemcpyAsync</text>
  <text x="940" y="1422" class="text">chunk2 → GPU</text>
  <text x="940" y="1439" class="text">↓</text>
  <text x="940" y="1456" class="text">processOnGPU</text>
  <text x="940" y="1473" class="text">↓</text>
  <text x="940" y="1490" class="text">cudaMemcpyAsync</text>
  <text x="940" y="1506" class="text">chunk2 ← GPU</text>
  
  <line x1="300" y1="1430" x2="300" y2="1550" class="arrow"/>
  <line x1="600" y1="1510" x2="600" y2="1550" class="arrow"/>
  <line x1="940" y1="1510" x2="940" y2="1550" class="arrow"/>
  
  <line x1="300" y1="1550" x2="600" y2="1550" class="arrow"/>
  <line x1="940" y1="1550" x2="600" y2="1550" class="arrow"/>
  
  <rect x="450" y="1550" width="300" height="80" rx="5" class="process"/>
  <text x="600" y="1575" class="text" font-weight="bold">Синхронизация всех:</text>
  <text x="600" y="1595" class="text">thread.join()</text>
  <text x="600" y="1612" class="text">cudaStreamSynchronize(stream1)</text>
  <text x="600" y="1628" class="text">cudaStreamSynchronize(stream2)</text>
  
  <line x1="600" y1="1630" x2="600" y2="1660" class="arrow"/>
  
  <rect x="450" y="1660" width="300" height="90" rx="5" class="process"/>
  <text x="600" y="1685" class="text" font-weight="bold">Анализ производительности:</text>
  <text x="600" y="1705" class="text">• Накладные расходы передачи</text>
  <text x="600" y="1722" class="text">• Эффект от async + streams</text>
  <text x="600" y="1739" class="text">• Сравнение всех 4 тестов</text>
  
  <line x1="600" y1="1750" x2="600" y2="1780" class="arrow"/>
  
  <path d="M 520 1780 L 680 1780 L 660 1830 L 500 1830 Z" class="io"/>
  <text x="590" y="1800" class="text">Вывод результатов:</text>
  <text x="590" y="1817" class="text">все времена и ускорения</text>
  
  <line x1="590" y1="1830" x2="590" y2="1860" class="arrow"/>
  
  <rect x="490" y="1860" width="220" height="60" rx="5" class="process"/>
  <text x="600" y="1880" class="text">Освобождение ресурсов:</text>
  <text x="600" y="1897" class="text">cudaFree, cudaFreeHost</text>
  <text x="600" y="1913" class="text">cudaStreamDestroy</text>
  
  <line x1="600" y1="1920" x2="600" y2="1950" class="arrow"/>
  
  <ellipse cx="600" cy="1980" rx="80" ry="30" class="start-end"/>
  <text x="600" y="1985" class="text">Конец</text>
  
</svg>
